{% extends 'base.html' %}

{% block imports %}
<link rel="stylesheet" href="{{ url_for('static', filename='misc.css') }}" />
<script src="{{ url_for('static', filename='clipboard.min.js') }}"></script>
{% endblock imports %}

{% block content %}

<body class="container-fluid">
  <div class="row">
    <div class="col-lg-12">
      <form action="/search">
        <div class="input-group">
          <span class="input-group-prepend">
            <button type="button" class="btn btn-primary" onclick="window.location = '/'">
              Home
            </button>
          </span>
          <input type="text" name="q" class="form-control" id="inp" autocomplete="off" list="search" value="{{query}}"
            placeholder="Search something" />
          <span class="input-group-append">
            <button type="button" class="btn btn-submit btn-primary" onclick="rand_img()">
              <img src="{{url_for('static', filename='shuffle.svg')}}" style="height: 1rem; width: 1rem;">
              <span class='bg-t-360 hide_on_phone'>Random image</span>
            </button>
          </span>
          <span class="input-group-append">
            <button type="submit" class="btn btn-primary">Search</button>
          </span>
        </div>
        <input name="page" value="1" style="visibility: hidden; width: 0; height: 0" />
      </form>
    </div>
  </div>
  <div>
    <div class=" text-center">
      {% if image[0].endswith('.webm') %}
      <video class="img img-fluid" preload="auto" autoplay controls muted loop>
        <source src="/raw/{{ image[-2] + image[0] }}" />
      </video>
      {% else %}
      <img src="/raw/{{ image[-2] + image[0] }}" class="ft" id="image" onclick="sw()" />
      {% endif %}<br />
    </div>
    <div class="text-center">
      <div class="btn-group">
        <button class="btn btn-primary" onclick="dl('{{ image[-2] + image[0] }}')">
          Download
        </button>
        <a class="btn btn-primary" data-clipboard-text="{{ image[-3] }}" id="clip">
          Copy CDN link
        </a>
        <button type="button" class="btn btn-primary dropdown-toggle"
          aria-haspopup="true" aria-expanded="false" data-toggle="dropdown">
          <span class="sr-only">Toggle Dropdown</span>
        </button>
        <div class="dropdown-menu" id='dropdown'>
          <a class="dropdown-item" id="open" onclick="view('{{ image[-2]}}{{image[0] }}')">
            View
          </a>
          <a class="dropdown-item" onclick="dcdn('{{ image[-3] }}')">
            View on CDN
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item" onclick="reloadimg('{{image[-2]}}{{image[-1]}}')">
            Redownload Image
          </a>
          <a class="dropdown-item" data-toggle="modal" data-target="#deletemodal">
            Delete entry
          </a>
        </div>
      </div>
    </div>
    <div>
      <h3>
        Tags: {% for i in image[1].split(',,')[1:-2] %}
        <a href="/search?q={{ i }}&page=1">{{ i }}</a>, {% endfor %} <a
          href="/search?q={{ image[1].split(',,')[-2] }}&page=1">{{ image[1].split(',,')[-2] }}</a>
      </h3>
    </div>
  </div>
  <datalist id="search" style="display: none"></datalist>

  <div class="modal fade" id="deletemodal" tabindex="-1" aria-labelledby="deletemodallabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deletemodallabel">Image removal</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          Are you sure you want to remove this image and DB entry?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Go back</button>
          <button type="button" class="btn btn-danger" onclick="removeimg('{{image[-2]}}{{image[-1]}}')">Yes, remove it</button>
        </div>
      </div>
    </div>
  </div>

</body>
{% endblock content %}

{% block scripts %}
<script type="application/javascript">
  var btn = document.getElementById("clip");
  var clipboard = new Clipboard(btn);

  function reloadimg(image) {
    xhr = new XMLHttpRequest()
    xhr.open("PATCH", "/reload/"+image, true)
    xhr.onload = function () {
      window.location = window.location
    }
    xhr.send()
  }

  function removeimg(image) {
    xhr = new XMLHttpRequest()
    xhr.open("DELETE", "/remove/"+image, true)
    xhr.onload = function () {
      window.location = window.location.origin
    }
    xhr.send()
  }

  function view(id) {
    win = window.open("/raw/" + id, "_blank");
    win.focus();
  }
  
  function dl(id) {
    var a = document.createElement("a");
    a.style.display = "none";
    a.href = "/dl/" + id;
    a.setAttribute("download", id);
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    delete a;
  }

  function dcdn(link) {
    win = window.open(link, "_blank");
    win.focus();
  }

  function sw() {
    var img = document.getElementById("image");
    img.classList.toggle("img");
    img.classList.toggle("img-fluid");
    img.classList.toggle("ft");
  }

  document.onkeydown = function (e) {
    if ((e.keyCode === 39 || e.keyCode === 37) && e.target.className != "form-control") {
      xhr = new XMLHttpRequest();
      body = String(window.location.pathname).split("/");
      body = body[body.length - 1] + "?q=" + document.getElementById("inp").value
      if (e.keyCode === 39 && e.target.className != "form-control") {
        xhr.open("GET", "/previous/" + body, true);
      } else if (e.keyCode === 37 && e.target.className != "form-control") {
        xhr.open("GET", "/next/" + body, true);
      }
      xhr.send();
      xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status == 200) {
          window.location = "/image/" + xhr.responseText;
        } else if (xhr.readyState === XMLHttpRequest.DONE && xhr.status == 404) {
          i = 1;
        }
      };
    }
    if (e.keyCode === 82 && e.target.className != "form-control" && e.target.id != 'inp') {
      rand_img();
    }
  };
</script>
{% endblock scripts %}